---
title: "3-Configuration"
date: "10/26/2021"
output:
  html_document: 
    keep_md: yes
    toc: true
  md_document:
    variant: gfm
---

```{r, setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

In the last section, we formatted and configured our data to make it accessible to the browser.
In this section, we'll create two sets of configuration instructions:
- `db_config.yml` - located with the database files, and specific to each database
- `omicser_options.yml` - located in the run directory, provides top-level configuration and identifies the database(s) accessible for visualization in the browser

We'll continue to refer to the [PBMC3k example script](https://github.com/ndcn/omicser/blob/main/examples/browse_pbmc3k.R)
as our example.

## Database configuration

Creating the configuration file for a database provides the basic instructions 
to the browser for how data will be represented to and manipulated 
by the viewers of the application while browsing.
This involves defining the experimental factors as well as visualization parameters.

The example below matches the PBMC3k.
Please see the [`examples/`](https://github.com/ndcn/omicser/tree/main/examples) for alternative configurations.

``` {r, 4-config-1, eval=FALSE}
# differentials: the order here dictates the order in which they will appear in the browser
conf_list <- list(
  x_obs = c("leiden"),
  # measures
  y_obs =  c('n_genes', 'n_genes_by_counts', 'total_counts', 'total_counts_mt', 'pct_counts_mt'),
  obs_groupby = c("leiden"),
  obs_subset = c("leiden"),

  x_var = c("decile","highly_variable"),
  y_var = c( 'n_cells', 'mt', 'n_cells_by_counts', 'mean_counts',
            'pct_dropout_by_counts', 'total_counts',
            'means', 'dispersions', 'dispersions_norm', 'mean', 'std'),

  var_groupby = c("decile","highly_variable"),
  var_subset = c("decile","highly_variable"),

  diffs = list(diff_exp_comps = levels(factor(diff_exp$versus)),
               diff_exp_comp_type =  levels(factor(diff_exp$comp_type)), #i don't think we need this
               diff_exp_obs_name =  levels(factor(diff_exp$obs_name)),
               diff_exp_tests =  levels(factor(diff_exp$test_type))),

  layers = c("X","raw"),

  # dimension reduction
  dimreds = list(obsm = ad$obsm_keys(),
                 varm = ad$varm_keys()),

  # setting defaults for ad$obs 
  default_factors = default_factors,
  target_omics = target_omics,
  omic_details = c('gene_ids', 'n_cells', 'mt', 'n_cells_by_counts',
                   'mean_counts', 'pct_dropout_by_counts', 'total_counts',
                   'highly_variable', 'means', 'dispersions',
                   'dispersions_norm', 'mean', 'std', 'var_rank', 'decile')))

# write db_config.yml to database directory
configr::write.config(config.dat = conf_list, 
                      file.path = file.path(DS_ROOT_PATH, DB_NAME, "db_config.yml"),
                      write.type = "yaml", indent = 4)
```

## Browser configuration

Top-level configuration lets the browser know where the database can be found.
The following code 

```{r, omicser-options, eval=FALSE}
# define omicser options
omicser_options <- list(database_names = DB_NAME,
                        db_root_path = DB_ROOT_PATH,
                        conda_environment = CONDA_ENV)

# write omicser_options.yml to run directory
omicser::write_config(omicser_options, in_path = OMICSER_RUN_DIR)
```

To configure a the browser for multiple databases,
please see the [Visualizing multiple datasets](multiple_databases.md) information.

We're done preparing our data and configuration!
The next step will be to [launch the browser and prepare to share with collaborators](04_sharing.md).
